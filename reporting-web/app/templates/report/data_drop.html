<!--
data_drop.html:
Implements drop boxes for data fields. Data dropped in these boxes are readied
for display.
/-->
{% include "/report/data_handlers.html" %}

<link rel="stylesheet" href="{{url_for('static', filename='css/common/token-input.css')}}" type="text/css" />

<style>
  .form-horizontal .control-label {
    text-align: right;
  }
  .form-horizontal .form-group {
    margin-bottom: 0px;
  }
</style>

<script>
  var ns = App.namespace("App.Studio.Data");

  ns.DataToken = function( dataItem, uiCallback ) {
    var token = $( "<li></li>" ).addClass( "token-input-token" );
    $( "<p></p>" ).html( dataItem.text() ).appendTo( token );
    $( "<span></span>" ).addClass( "icon-remove-sign" ).click( function() {
      this.parentNode.remove();
      uiCallback( this );
    }).appendTo( token );
    // Set object properties
    token.prop( "id", dataItem.data( "data-name" ) );
    token.data( "data-handler", new App.Studio.Data.DataHandler( dataItem ) );
    return token;
  }

  ns.DataDropWidget = function( uiCallback ) {
    var dataDrop = $( "#template-data-drop" ).contents().clone();
    $( ".droppable-input", dataDrop ).droppable({
      activeClass: "ui-state-default",
      drop: function( event, ui ) {
        $( "#placeholder", this ).before( new App.Studio.Data.DataToken( ui.draggable, uiCallback ));
        uiCallback( this );
      }
    });
    return dataDrop;
  }

  // Return array of keys for grouping columns
  ns.getXdataColumnKeys = function( domContext ) {
    var columnKeys = $( "#x-tokens .token-input-token", domContext ).map( function() {
      var data_handler = $( this ).data( "data-handler" );
      if ( data_handler != undefined ) {
        return data_handler.modify();
      }
    });
    return columnKeys ? columnKeys.get() : [];
  }

  ns.getYdataColumnKeys = function( domContext ) {
    var columnKeys = $( "#y-tokens .token-input-token", domContext ).map( function() {
      var data_handler = $( this ).data( "data-handler" );
      if ( data_handler != undefined ) {
        return data_handler.combine();
      }
    });
    return columnKeys ? columnKeys.get() : [];
  }

  ns.formatColumns = function( dataTable, domContext ) {
    // TODO:  in pseudocode
    for ( var index = 0; index < dataTable.getNumberOfColumns(); index++ ) {
      var dataName  = dataTable.getColumnLabel( index );
      var dataToken = $( "#" + dataName + ".token-input-token", domContext );
      var data_handler = $( dataToken ).data( "data-handler" );
      if ( data_handler != undefined ) {
        data_handler.format( dataTable, index );
      }
    }
  }

</script>

<!-- templated html block -->
<div id="template-data-drop" style="display: none">
  <div id="data-drop" class="container">
    <div class="input-group input-group-md" style="margin-bottom: 15px">
    <span class="input-group-addon"><em>X</em></span>
    <ul id="x-tokens" class="form-control input-md droppable-input token-input-list">
      <li id="placeholder">
        <input type="text" autocomplete="off" style="outline: none" placeholder="" disabled="true">
      </li>
    </ul>
    </div>
    <div class="input-group input-group-md" style="margin-bottom: 15px">
    <span class="input-group-addon"><em>Y</em></span>
    <ul id="y-tokens" class="form-control input-md droppable-input token-input-list">
      <li id="placeholder">
        <input type="text" autocomplete="off" style="outline: none" placeholder="" disabled="true">
      </li>
    </ul>
    </div>
  </div><!-- .container -->
  <!--
  <form class="form-horizontal" role="form">
    <div class="form-group">
      <label class="col-md-2 control-label">X </label>
      <div class="col-md-10">
        <ul class="droppable-input token-input-list" style="width: auto; height: auto;">
          <li id="placeholder">
            <input type="text" autocomplete="off" style="outline: none" placeholder="" disabled="true">
          </li>
        </ul>
      </div>
    </div>
    <div class="form-group">
      <label class="col-md-2 control-label">Y </label>
      <div class="col-md-10">
        <ul class="droppable-input token-input-list" style="width: auto; height: auto;">
          <li id="placeholder">
            <input type="text" autocomplete="off" style="outline: none" placeholder="" disabled="true">
          </li>
        </ul>
      </div>
    </div>
  </form>
  -->
</div>