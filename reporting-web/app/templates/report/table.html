{% extends "/common/main.html" %}

{% block style %}
    {{ super() }}
    <link rel="stylesheet" href="{{url_for('static', filename='js/libs/jquery-tokeninput/styles/token-input-facebook.css')}}" type="text/css" />

    <style>
    .highlight {
      border: 1px solid red;
      font-weight: bold;
      font-size: 45px;
      background-color: lightblue;
    }
    .form-horizontal .control-label {
      text-align: right;
    }
    .form-horizontal .form-group {
      margin-bottom: 0px;
    }
    </style>
{% endblock style %}

{% block script %}
    {{ super() }}
    <script type="text/javascript" src="//www.google.com/jsapi"></script>

    <script>
    //This has been called with sql:'{{ sql }}' for database '{{ datasource }}' 
    
    // Load google charts visualization module(s)
    google.load('visualization', '1', {packages:['table']});

    function newDataListItem( dataName, dataType ) {
      listItem = $( "<li></li>" ).addClass( "list-group-item" ).html( dataName );
      badge = $( "<span></span>" ).addClass( "badge" )
      switch ( dataType ) {
        case "number":
          $( "<i></i>" ).addClass( "icon-signal icon-white" ).appendTo( badge );
          break;
        case "date":
        case "timeofday":
        case "datetime":
          $( "<i></i>" ).addClass( "icon-date icon-white" ).appendTo( badge );
          break;
        case "string":
           $( "<i></i>" ).addClass( "icon-font icon-white" ).appendTo( badge );
          break;         
        case "money":
          $( "<i></i>" ).addClass( "icon-usd icon-white" ).appendTo( badge );
          break;
        case "boolean":
        default:
          $( "<i></i>" ).addClass( "icon-question-sign icon-white" ).appendTo( badge );
          break;
      }
      badge.appendTo( listItem );
      return listItem[0];
    }

    function newDimensionsListItem( dataObject ) {
      if ( dataObject.type.toLowerCase() != "number" ) {
        return newDataListItem( dataObject.name, dataObject.type.toLowerCase() );
      }
      return;
    }

    function newMeasuresListItem( dataObject ) {
      if ( dataObject.type.toLowerCase() == "number" ) {
        return newDataListItem( dataObject.name, dataObject.type.toLowerCase() );
      }
      return;
    }

    function newDeletableStringToken( tokenName ) {
          var token = $( "<li></li>" ).addClass( "token-input-token-facebook" ).attr( "id", tokenName);
          $( "<p></p>" ).html( tokenName ).appendTo( token );
          $( "<span></span>" ).addClass( "icon-remove-sign" ).click( function() {
            this.parentNode.remove();
            drawDataTable();
          }).appendTo( token );
          return token[0];
    }

    function newWorksheet() {
      var nsheets = $( "#workbook .tab-pane" ).length - 1;
      var sheetId = "worksheet-".concat(nsheets.toString());
      var sheetLabel = "Worksheet ".concat(nsheets.toString());
      // Create new plane by copying the template
      var sheetPane = $( "#template-sheet-pane" ).clone().css({
        display: "" 
      }).prop( "id", sheetId ).addClass( "active" );
      // Define callback for droppable inputs
      $( ".droppable-input", sheetPane ).droppable({
        activeClass: "ui-state-default",
        drop: function( event, ui ) {
          $("#placeholder", this).before( newDeletableStringToken( ui.draggable.text() ));
          drawDataTable();
        }
      });
      // Create new tab by copying the template
      var sheetTab = $( "#template-sheet-tab" ).clone().css({
        display: ""
      }).prop( "id", sheetId.concat("-tab") ).addClass( "active" );
      $( "a", sheetTab ).prop( "href", "#".concat( sheetPane.prop( "id" ))).html( sheetLabel );
      // Insert into document
      $( "#new-sheet-pane" ).before( sheetPane );
      $( "#new-sheet-tab"  ).before( sheetTab  );
      return sheetTab;
    }

    function activateNewWorksheet() {
      var sheetTab = newWorksheet();
      //$( "#new-sheet-tab" ).removeClass( "active" );
      $( sheetTab ).addClass( "active" );
    }

    function fusionTableColumns( tableId, apiKey ) {
      // Construct query
      var url = 'https://www.googleapis.com/fusiontables/v1/tables/' + tableId;
      url += '?key=' + apiKey;
      return url;
    }

    function fusionTableData( tableId, apiKey ) {
      // Construct query
      var query = 'SELECT * FROM ' + tableId;
      // Construct the URL
      var url = [ 'https://www.googleapis.com/fusiontables/v1/query' ];
      url.push( '?sql=' + encodeURIComponent( query ) );
      url.push( '&key=' + apiKey );
      //url.push( '&typed=true' );
      return url.join('');
    }

    /*
    function newDataTable(sql_data) {
      var dataTable = new google.visualization.DataTable();
      for (var i = 0; i < sql_data.facts.length; i++) {
        var col = sql_data.facts[i];
        if (i==1 || i==2) {
          col.coltype = "string";
        } else {
          col.coltype = "number";
        }
        dataTable.addColumn( col.coltype, col.colname );
      }
      for (var i = 0; i < sql_data.dimensions.length; i++) {
        var col = sql_data.dimensions[i];
        dataTable.addColumn( col.coltype, col.colname );
      }
      dataTable.addRows(sql_data.data);
      return dataTable;
    }
    */
    function newDataTable( json ) {
      console.log( json );
      var dataTable = new google.visualization.DataTable();
      for (var i = 0; i < json.columns.length; i++) {
        var dataObject = json.columns[i];
        var dataType   = dataObject.type.toLowerCase();
        switch ( dataType ) {
          case 'boolean':
          case 'date':
          case 'datetime':
          case 'number':
          case 'string':
          case 'timeofday':
            break;
          case 'location':
          default:
            dataType = 'string';
            break;
        }
        dataTable.addColumn( dataType, dataObject.name, i );
      }
      $( "#workbook" ).prop( "dataTable", dataTable );
      return dataTable;
    }

    function loadDataTable( dataTable, json ) {
      console.log( json );
      for ( var i = 0; i < json.rows.length; i++ ) {
        var encodedRow = $( json.rows[i] ).map( function( sval, index ) {
          switch ( dataTable.getColumnType( index) ) {
            case 'boolean':
              return parseInt( sval );
              break;
            case 'number':
              return 
            case 'date':
              break;
          }
        }
      });
      //dataTable.addRows( json.rows );
      return dataTable;
      //$( "#workbook" ).prop( "dataTable", newDataTable( json ) );
      //console.log( getDataTable() );
    }

    function getDataTable() {
       var dataTable  = $( "#workbook" ).prop( "dataTable" );
       return dataTable;
    }

    function getActiveWorksheet() {
      var sheet = $( "#sheet-panes > .tab-pane.active" );
      return sheet[0];
    }

    // Return array of dimensions stored for given view
    function getViewDimensions( this_sheet ) {
      var dimensions = $( "ul .token-input-token-facebook", this_sheet ).map( function() {
        return this.id;
      }).get();
      return dimensions;
    }

    // Given array of column names, find corresponding indeces into dataTable
    function getDataTableColumnIndeces( colNames, dataTable) {
      var colIndeces = $( colNames ).map( function() {
        for ( var i = 0; i < dataTable.H.length; i++ ) {
          if ( this == dataTable.H[i].label ) return i;
        }
        return; // Name not found, return nothing
      }).get();
      return colIndeces;
    }

    // Draw routine and main entry point for displaying data
    function drawDataTable() {
      var this_sheet = getActiveWorksheet();
      var dataTable  = getDataTable();
      if ( this_sheet != undefined && dataTable != undefined ) {
        // Get column names then find their corresponding table indeces
        var dimensions = getViewDimensions( this_sheet );
        var colIndeces = getDataTableColumnIndeces( dimensions, dataTable );
        // Create dataView and display in view pane
        var viewpane = new google.visualization.Table( $( "#data-view", this_sheet )[0] );
        var dataView = new google.visualization.DataView( dataTable );
        dataView.setColumns( colIndeces );
        viewpane.draw( dataView );
      }
    }

    $(document).ready( function() {

      /*
      $.ajax({
        url:"/report/create/step2/pulldata", 
        type: "POST",
        data: {
          datasource: "{{ datasource }}",
          sql: "{{ sql }}" 
        },
        success: function( result ){
          $( "#dimensions-list"   ).append( $.map(result.facts, newDataListItem) );
          $( "#measures-list" ).append( $.map(result.dimensions, newDataListItem) );
          $( "#workbook" ).prop( "dataTable", newDataTable(result) );
        }
      });
      */

      var dataTable = undefined;
      var tableId = '1r3cTnnutaRKVep7tVwqmWjRLk1Ffl_s4uooaBc0';
      var apiKey  = 'AIzaSyCJw77UIjzePhi5tPw_t_EKJzgtLFMHVqM';

      $.get( fusionTableColumns( tableId, apiKey ), function( json ) {
        dataTable = newDataTable( json );
        $( "#dimensions-list" ).append( $.map(json.columns, newDimensionsListItem) );
        $( "#measures-list" ).append( $.map(json.columns, newMeasuresListItem) );
      });

      $.get( fusionTableData( tableId, apiKey ), function( json ) {
        loadDataTable( dataTable, json );
      });

      $('.sortable').sortable({
        tolerance: "pointer",
        connectWith: ".sortable",
        placeholder: "list-group-item",
        forcePlaceholderSize: true,
        appendTo: "body",
        helper: "clone",
        cursor: "move",
        opacity: .8,
        zIndex: 666
      }).disableSelection();
	
      newWorksheet();

    });
    </script>
{% endblock script %}

{% block header %}
    {% include "/report/header.html" %}
{% endblock header %}

{% block content %}
    <div id="studio" class="bordered container theme-showcase">
      <div class="row">
        <div id="sidebar" class="col-md-2 col-xs-3" style="height: auto">
          <div id="headers-group" class="container">
            <div class="panel panel-default" style="height: auto">
              <div class="panel-heading">
                <span class="panel-title">Dimensions</span>
              </div>
              <ul id="dimensions-list" class="sortable list-group">
                <!-- create new list group items here -->
              </ul>
            </div><!-- /.panel -->

            <div class="panel panel-default" style="height: auto">
              <div class="panel-heading">
                <span class="panel-title">Measures</span>
              </div>
              <ul id="measures-list" class="sortable list-group">
                <!-- create new list group items here -->
              </ul>
            </div><!-- /.panel -->
          </div><!-- /#headers-group -->
        </div><!-- /#sidebar -->

        <div id="workbook" class="col-md-10 col-xs15 tabbable" style="height: auto">

          <ul id="sheet-tabs" class="nav nav-tabs">
            <li id="new-sheet-tab" onMouseUp="activateNewWorksheet()"><a href="#new-sheet-pane" data-toggle="tab"><i class="icon-plus icon-white"></i></a></li>
            <li id="template-sheet-tab" style="display: none"><a href="#template-sheet-pane" data-toggle="tab">Template Worksheet</a></li>
          </ul>

          <div id="sheet-panes" class="tab-content" style="height: auto">
            <div id="new-sheet-pane" class="tab-pane container">
            </div>
            <div id="template-sheet-pane" class="tab-pane container" style="display: none">
              <form class="form-horizontal" role="form">
                <div class="form-group">
                  <label class="col-md-1 control-label">Rows</label>
                  <div class="col-md-11">
                    <ul class="droppable-input token-input-list-facebook" style="width: auto; height: auto;">
                      <li id="placeholder">
                        <input type="text" autocomplete="off" style="outline: none" placeholder="" disabled="true">
                      </li>
                    </ul>
                  </div>
                </div>
                <!-- /.form-group -->
                <div class="form-group">
                  <label class="col-md-1 control-label">Columns</label>
                  <div class="col-md-11">
                    <ul class="droppable-input token-input-list-facebook" style="width: auto; height: auto;">
                      <li id="placeholder">
                        <input type="text" autocomplete="off" style="outline: none" placeholder="" disabled="true">
                      </li>
                    </ul>
                  </div>
                </div><!-- /.form-group -->
              </form><!-- /.form-horizontal -->
              <div class="container" style="height: auto">
                <div id='data-view'></div>
              </div>              
            </div><!-- /#template-sheet-pane -->
          </div><!-- .tab-content -->
        </div><!-- /#workbook -->
      </div><!-- /.row -->
    </div> <!-- /#studio -->
{% endblock %}
