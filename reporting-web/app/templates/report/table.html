{% extends "/common/main.html" %}

{% block style %}
    {{ super() }}
{% endblock style %}

{% block script %}
    {{ super() }}
    <script type="text/javascript" src="//www.google.com/jsapi"></script>
    <script type="text/javascript" src="{{url_for('static',filename='js/libs/jquery-layout/jquery.layout-latest.js')}}"></script>
    <script type="text/javascript" src="{{url_for('static', filename='js/report/gdata_table.js')}}"></script>

    <script>
    //This has been called with sql:'{{ sql }}' for database '{{ datasource }}' 
    
    // Load google charts visualization module(s)
    google.load("visualization", "1", {packages:["table"]});

    function newWorksheet() {
      var nsheets = $( "#workbook .tab-pane" ).length - 1;
      var sheetId = "worksheet-".concat(nsheets.toString());
      var sheetLabel = "Worksheet ".concat(nsheets.toString());
      // Create new plane by copying the template
      var sheetPane = $( "#template-sheet-pane" ).clone().css({
        display: "" 
      }).prop( "id", sheetId ).addClass( "active" );
      initDataDrop( sheetPane );
      // Create new tab by copying the template
      var sheetTab = $( "#template-sheet-tab" ).clone().css({
        display: ""
      }).prop( "id", sheetId.concat("-tab") ).addClass( "active" );
      $( "a", sheetTab ).prop( "href", "#".concat( sheetPane.prop( "id" ))).html( sheetLabel );
      // Insert into document
      $( "#new-sheet-pane" ).before( sheetPane );
      $( "#new-sheet-tab"  ).before( sheetTab  );
      return sheetTab;
    }

    function activateNewWorksheet() {
      var sheetTab = newWorksheet();
      //$( "#new-sheet-tab" ).removeClass( "active" );
      $( sheetTab ).addClass( "active" );
    }

    function getActiveDataTable() {
       var dataTable  = $( "#workbook" ).prop( "dataTable" );
       return dataTable;
    }

    function getActiveWorksheet() {
      var sheet = $( "#sheet-panes > .tab-pane.active" );
      return sheet[0];
    }

    // Draw routine and main entry point for displaying data
    function drawDataTable() {
      var thisSheet = getActiveWorksheet();
      var dataTable = getActiveDataTable();
      if ( thisSheet != undefined && dataTable != undefined ) {
        // Get column names then find their corresponding table indeces
        var dimensions = getViewDimensions( thisSheet );
        var colIndeces = getDataTableColumnIndeces( dimensions, dataTable );
        // Create dataView and display in view pane
        var viewpane = new google.visualization.Table( $( "#data-view", thisSheet )[0] );
        var dataView = new google.visualization.DataView( dataTable );
        dataView.setColumns( colIndeces );
        viewpane.draw( dataView );
      }
    }

    $(document).ready( function() {

      /*
      $.ajax({
        url:"/report/create/step2/pulldata", 
        type: "POST",
        data: {
          datasource: "{{ datasource }}",
          sql: "{{ sql }}" 
        },
        success: function( result ){
          $( "#dimensions-list"   ).append( $.map(result.facts, newDataListItem) );
          $( "#measures-list" ).append( $.map(result.dimensions, newDataListItem) );
          $( "#workbook" ).prop( "dataTable", newDataTable(result) );
        }
      });
      */

      // Get column headers from fusion table and populate data-fields pane
      var tableId = "1r3cTnnutaRKVep7tVwqmWjRLk1Ffl_s4uooaBc0";
      var apiKey  = "AIzaSyCJw77UIjzePhi5tPw_t_EKJzgtLFMHVqM";

      $.get( fusionTableColumns( tableId, apiKey ), function( json ) {
        $( "#workbook" ).prop( "dataTable", newDataTable( json ) );
        var dimensions = $( "#dimensions-list" ).append( $.map(json.columns, newDimensionsListItem) );
        var measures   = $( "#measures-list" ).append( $.map(json.columns, newMeasuresListItem) );
        initDataStore();
      });

      // Get fusion table data to populate dataTable object
      $.get( fusionTableData( tableId, apiKey ), function( json ) {
        loadDataTable( getActiveDataTable(), json );
      });
	
      // Initialize work area with blank worksheet
      newWorksheet();

    });
    </script>
{% endblock script %}

{% block header %}
    {% include "/report/header.html" %}
{% endblock header %}

{% block content %}
    <div id="studio" class="bordered container theme-showcase">
      <div class="row" style="height: 100%">
        <div id="sidebar" class="col-md-2 col-xs-3" style="height: 100%">
          {% include "/report/data_store.html" %}
        </div>
        <div id="workbook" class="col-md-10 col-xs15 tabbable" style="height: auto">
          <ul id="sheet-tabs" class="nav nav-tabs">
            <li id="new-sheet-tab" onMouseUp="activateNewWorksheet()"><a href="#new-sheet-pane" data-toggle="tab"><i class="icon-plus icon-white"></i></a></li>
            <li id="template-sheet-tab" style="display: none"><a href="#template-sheet-pane" data-toggle="tab">Template Worksheet</a></li>
          </ul>
          <div id="sheet-panes" class="tab-content" style="height: auto">
            <div id="new-sheet-pane" class="tab-pane container">
            </div>
            <div id="template-sheet-pane" class="tab-pane container" style="display: none">
              {% include "/report/data_drop.html" %}
              <div class="container" style="height: auto">
                <div id="data-view"></div>
              </div>              
            </div><!-- /#template-sheet-pane -->
          </div><!-- .tab-content -->
        </div><!-- /#workbook -->
      </div><!-- /.row -->
    </div> <!-- /#studio -->
{% endblock %}
