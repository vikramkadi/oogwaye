{% extends "/common/main.html" %}

{% block style %}
    {{ super() }}
    <link rel="stylesheet" href="{{url_for('static', filename='js/libs/jquery-tokeninput/styles/token-input-facebook.css')}}" type="text/css" />
    <style>
    .highlight {
      border: 1px solid red;
      font-weight: bold;
      font-size: 45px;
      background-color: lightblue;
    }
    .form-horizontal .control-label {
      text-align: right;
    }
    .form-horizontal .form-group {
      margin-bottom: 0px;
    }
    </style>
{% endblock style %}

{% block script %}
    {{ super() }}
    <script type="text/javascript" src="//www.google.com/jsapi"></script>

    <script>
    //This has been called with sql:'{{ sql }}' for database '{{ datasource }}' 
    
    // Load google charts visualization module(s)
    google.load('visualization', '1', {packages:['table']});

    function newDataListItem( dataItem ) {
      listItem = $( "<li></li>" ).addClass( "list-group-item" ).html( dataItem.colname );
      badge = $( "<span></span>" ).addClass( "badge" )
      switch ( dataItem.index ) {
        case 1:
        case 2:
          $( "<i></i>" ).addClass( "icon-font icon-white" ).appendTo( badge );
          break;
        case 0:
        case 3:
          $( "<i></i>" ).addClass( "icon-signal icon-white" ).appendTo( badge );
          break;
        case 4:
          $( "<i></i>" ).addClass( "icon-date icon-white" ).appendTo( badge );
          break;
        case 5:
        case 6:
          $( "<i></i>" ).addClass( "icon-usd icon-white" ).appendTo( badge );
          break;
        default:
          $( "<i></i>" ).addClass( "icon-font icon-white" ).appendTo( badge );
          break;
      }
      badge.appendTo( listItem );
      return listItem[0];
    }

    function newDeletableStringToken( text ) {
          var token = $( "<li></li>" ).addClass( "token-input-token-facebook" );
          $( "<p></p>" ).html( text ).appendTo( token );
          $( "<span></span>" ).addClass( "icon-remove-sign" ).click( function() {
            this.parentNode.remove();
          }).appendTo( token );
          return token[0];
    }

    function newWorksheet() {
      var nsheets = $( "#workbook .tab-pane" ).length - 1;
      var sheetId = "worksheet-".concat(nsheets.toString());
      var sheetLabel = "Worksheet ".concat(nsheets.toString());
      // Create new plane by copying the template
      var sheetPane = $( "#template-sheet-pane" ).clone().css({
        display: "" 
      }).prop( "id", sheetId ).addClass( "active" );
      // Define callback for droppable inputs
      $( ".droppable-input", sheetPane ).droppable({
        activeClass: "ui-state-default",
        drop: function( event, ui ) {
          $("#placeholder", this).before( newDeletableStringToken( ui.draggable.text() ));
          drawDataTable();
        }
      });
      // Create new tab by copying the template
      var sheetTab = $( "#template-sheet-tab" ).clone().css({
        display: ""
      }).prop( "id", sheetId.concat("-tab") ).addClass( "active" );
      $( "a", sheetTab ).prop( "href", "#".concat( sheetPane.prop( "id" ))).html( sheetLabel );
      // Insert into document
      $( "#new-sheet-pane" ).before( sheetPane );
      $( "#new-sheet-tab"  ).before( sheetTab  );
      return sheetTab;
    }

    function activateNewWorksheet() {
      var sheetTab = newWorksheet();
      //$( "#new-sheet-tab" ).removeClass( "active" );
      $( sheetTab ).addClass( "active" );
    }

    function getActiveWorksheet() {
      var sheet = $( "#sheet-panes > .tab-pane.active" );
      return sheet[0];
    }

    function newDataTable(sql_data) {
      var dataTable = new google.visualization.DataTable();
      for (var i = 0; i < sql_data.facts.length; i++) {
        var col = sql_data.facts[i];
        if (i==1 || i==2) {
          col.coltype = "string";
        } else {
          col.coltype = "number";
        }
        dataTable.addColumn( col.coltype, col.colname );
      }
      for (var i = 0; i < sql_data.dimensions.length; i++) {
        var col = sql_data.dimensions[i];
        dataTable.addColumn( col.coltype, col.colname );
      }
      dataTable.addRows(sql_data.data);
      return dataTable;
    }

    /*
    function newDataTable(json_data) {
      var data = new google.visualization.DataTable();
      data.addColumn('string', 'Name');
      data.addColumn('number', 'Salary');
      data.addColumn('boolean', 'Full Time Employee');
      data.addRows([
        ['Mike',  {v: 10000, f: '$10,000'}, true],
        ['Jim',   {v:8000,   f: '$8,000'},  false],
        ['Alice', {v: 12500, f: '$12,500'}, true],
        ['Bob',   {v: 7000,  f: '$7,000'},  true]
      ]);
      return data;
    }
    */

    function drawDataTable() {
      var active_sheet  = getActiveWorksheet();
      console.log( active_sheet );
      if ( active_sheet != undefined ) {
        var table = new google.visualization.Table( $( "#data-view", active_sheet )[0] );
        var data  = $( "#workbook" ).prop( "dataTable" );
        console.log( $( "#data-view", active_sheet)[0] );
        table.draw( data );
      }
    }

    $(document).ready( function() {

      $.ajax({
        url:"/report/create/step2/pulldata", 
        type: "POST",
        data: {
          datasource: "{{ datasource }}",
          sql: "{{ sql }}" 
        },
        success: function(result){
          $( "#dimensions-list"   ).append( $.map(result.facts, newDataListItem) );
          $( "#measures-list" ).append( $.map(result.dimensions, newDataListItem) );
          console.log(result);
          $( "#workbook" ).prop( "dataTable", newDataTable(result) );
        }
      });

      $('.sortable').sortable({
        tolerance: "pointer",
        connectWith: ".sortable",
        placeholder: "list-group-item",
        forcePlaceholderSize: true,
        appendTo: "body",
        helper: "clone",
        cursor: "move",
        opacity: .8,
        zIndex: 666
      }).disableSelection();
	
      newWorksheet();

    });
    </script>
{% endblock script %}

{% block header %}
    {% include "/report/header.html" %}
{% endblock header %}

{% block content %}
    <div id="studio" class="bordered container theme-showcase">
      <div class="row">
        <div id="sidebar" class="col-md-2 col-xs-3" style="height: auto">
          <div id="headers-group" class="container">
            <div class="panel panel-default" style="height: auto">
              <div class="panel-heading">
                <span class="panel-title">Dimensions</span>
              </div>
              <ul id="dimensions-list" class="sortable list-group">
                <!-- create new list group items here -->
              </ul>
            </div><!-- /.panel -->

            <div class="panel panel-default" style="height: auto">
              <div class="panel-heading">
                <span class="panel-title">Measures</span>
              </div>
              <ul id="measures-list" class="sortable list-group">
                <!-- create new list group items here -->
              </ul>
            </div><!-- /.panel -->
          </div><!-- /#headers-group -->
        </div><!-- /#sidebar -->

        <div id="workbook" class="col-md-10 col-xs15 tabbable" style="height: auto">

          <ul id="sheet-tabs" class="nav nav-tabs">
            <li id="new-sheet-tab" onMouseUp="activateNewWorksheet()"><a href="#new-sheet-pane" data-toggle="tab"><i class="icon-plus icon-white"></i></a></li>
            <li id="template-sheet-tab" style="display: none"><a href="#template-sheet-pane" data-toggle="tab">Template Worksheet</a></li>
          </ul>

          <div id="sheet-panes" class="tab-content" style="height: auto">
            <div id="new-sheet-pane" class="tab-pane container">
            </div>
            <div id="template-sheet-pane" class="tab-pane container" style="display: none">
              <form class="form-horizontal" role="form">
                <div class="form-group">
                  <label class="col-md-1 control-label">Rows</label>
                  <div class="col-md-11">
                    <ul class="droppable-input token-input-list-facebook" style="width: auto; height: auto;">
                      <li id="placeholder">
                        <input type="text" autocomplete="off" style="outline: none" placeholder="" disabled="true">
                      </li>
                    </ul>
                  </div>
                </div>
                <!-- /.form-group -->
                <div class="form-group">
                  <label class="col-md-1 control-label">Columns</label>
                  <div class="col-md-11">
                    <ul class="droppable-input token-input-list-facebook" style="width: auto; height: auto;">
                      <li id="placeholder">
                        <input type="text" autocomplete="off" style="outline: none" placeholder="" disabled="true">
                      </li>
                    </ul>
                  </div>
                </div><!-- /.form-group -->
              </form><!-- /.form-horizontal -->
              <div class="container" style="height: auto">
                <div id='data-view'></div>
              </div>              
            </div><!-- /#template-sheet-pane -->
          </div><!-- .tab-content -->
        </div><!-- /#workbook -->
      </div><!-- /.row -->
    </div> <!-- /#studio -->
{% endblock %}
