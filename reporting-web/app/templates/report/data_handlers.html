<!--
data_handlers.html:
Implements data handlers, i.e.  for grouping, aggregating, and formatting the different types of data.
/-->
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/datejs/1.0/date.min.js"></script>

<script>
  // Declare namespace
  var ns = App.namespace("App.Studio.Data");

  // Modifier class
  ns.Modifier = function( columnId, columnName, modifier, returnType ) {
    this.id = columnName;
    this.label = columnName;
    this.column = columnId;
    this.modifier = modifier;
    this.type = returnType;
  }

  // Data Modifying Operations
  ns.ModifyOps = {
    DAY: {  
      func: function( date ) {
        return date.clearTime();
      },
      type: "date"
    },
    MONTH: {
      func: function( date ) {
        return date.moveToFirstDayOfMonth();
      },
      type: "date"
    },
    QUARTER: {
      func: function( date ) {
        return Math.floor( date.getMonth()/3 ) + 1;
      },
      type: "number"
    },
  }

  // Combiner class
  ns.Combiner = function( columnId, columnName, combiner, returnType ) {
    this.id = columnName;
    this.label = columnName;
    this.column = columnId;
    this.aggregation = combiner;
    this.type = returnType;
  }

  // Data Combining Operations
  ns.CombineOps = {
    AVG: {
      func: function( values ) {
        return google.visualization.data.avg( values );
      },
      type: "number"
    },
    MAX: {
      func: function( values ) {
        return google.visualization.data.max( values );
      },
      type: "number"
    }
  }

  // Formatting Operations
  ns.FormatOps = {
    DATE: {
      func: function( opts ) {
        return new google.visualization.DateFormat({
          pattern:  opts.pattern
        });
      }
    },
    USD: {
      func: function( opts ) {
        return new google.visualization.NumberFormat({
          prefix: '$', 
          negativeColor: 'red', 
          negativeParens: true
        });
      }
    }
  }

  // BasicHandler:  base class
  ns.BasicHandler = function () {
    this.dataName    = undefined;
    this.dataType    = undefined;
    this.columnId    = -1;
    this.modifyOp    = undefined;
    this.modifyArgs  = undefined;
    this.combineOp   = undefined;
    this.combineArgs = undefined;
    this.formatOp    = undefined;
    this.formatArgs  = undefined;
    // Common handler class methods

    this.getCombiner  = function() { return this.columnId; }
    this.getFormatter = function() { return undefined; }
  }
  ns.BasicHandler.prototype.getModifier  = function() { 
    var modifyOp = App.Studio.Data.ModifyOps[ this.modifyOp ];
    if ( modifyOp != undefined ) {
      return new App.Studio.Data.Modifier( this.columnId, this.dataName, modifyOp.func, modifyOp.type );
    } else {
      return this.columnId;
    }
  }
  ns.BasicHandler.prototype.getCombiner = function() {
    var combineOp = App.Studio.Data.CombineOps[ this.combineOp ];
    if ( combineOp != undefined ) {
      return new App.Studio.Data.Combiner( this.columnId, this.dataName, combineOp.func, combineOp.type );
    } else {
      return this.columnId;
    }
  }
  ns.BasicHandler.prototype.getFormatter = function() {
    var formatOp = App.Studio.Data.FormatOps[ this.formatOp ];
    if ( formatOp != undefined ) {
      return formatOp.func( this.formatArgs );
    } else {
      return undefined;
    }
  }
  ns.BasicHandler.prototype.info = function() {
    console.log( this.dataName + " of type " + this.dataType + " and id " + this.columnId);
    return;
  }

  // BooleanHandler
  ns.BooleanHandler = function( name, columnId ) {
    this.dataName  = name;
    this.columnId  = columnId;
  }
  ns.BooleanHandler.prototype = Object.create( ns.BasicHandler.prototype );
  ns.BooleanHandler.prototype.dataType = "boolean";

  // DateHandler
  ns.DateHandler  = function( name, columnId ) {
    this.dataName   = name;
    this.columnId   = columnId;
    this.modifyOp   = "DAY";    // TODO
    this.formatOp   = "DATE";
    this.formatArgs = { pattern: "MMMM d, yyyy" }
  }
  ns.DateHandler.prototype = Object.create( ns.BasicHandler.prototype );
  ns.DateHandler.prototype.dataType = "date";

  // LocationHandler
  ns.LocationHandler = function( name, columnId ) {
    this.dataName = name;
    this.columnId = columnId;
  }
  ns.LocationHandler.prototype = Object.create( ns.BasicHandler.prototype );
  ns.LocationHandler.prototype.dataType = "string";

  // NumberHandler
  ns.NumberHandler  = function( name, columnId ) { 
    this.dataName   = name;
    this.columnId   = columnId;
    this.combineOp  = "AVG";    // TODO
    this.formatOp   = "USD";
  }
  ns.NumberHandler.prototype = Object.create( ns.BasicHandler.prototype );
  ns.NumberHandler.prototype.dataType = "number";

  // StringHandler
  ns.StringHandler  = function( name, columnId ) {
    this.dataName  = name;
    this.columnId  = columnId;
    this.do_modify  = false;
    this.do_combine = false;
    this.do_format  = false;
  }
  ns.StringHandler.prototype = Object.create( ns.BasicHandler.prototype );
  ns.StringHandler.prototype.dataType = "string";
  
  // TimeHandler
  ns.TimeHandler = function( name, columnId ) {
    this.dataName = name;
    this.columnId = columnId;
  }
  ns.TimeHandler.prototype = Object.create( ns.BasicHandler.prototype );
  ns.TimeHandler.prototype.dataType = "timeofday";

  ns.DataHandler = function( dataItem ) {
    var dataName = dataItem.data( "data-name" );
    var dataType = dataItem.data( "data-type" );
    var columnId = dataItem.data( "column-id" );
    var dataHandler;
    switch ( dataType ) {
      case "boolean":
        dataHandler = new App.Studio.Data.StringHandler( dataName, columnId );
        break;
      case "date":
      case "datetime":
        dataHandler = new App.Studio.Data.DateHandler( dataName, columnId );
        break;
      case "location":
        dataHandler = new App.Studio.Data.LocationHandler( dataName, columnId );
        break;
      case "number":
        dataHandler = new App.Studio.Data.NumberHandler( dataName, columnId );
        break;
      case "string":
        dataHandler = new App.Studio.Data.StringHandler( dataName, columnId );
        break;
      case "timeofday":
        dataHandler = new App.Studio.Data.TimeDataHandler( dataName, columnId );
        break;
      default:
        dataHandler = new App.Studio.Data.StringHandler( dataName, column_Id );
        break;
    }
    return dataHandler;
  }
</script>